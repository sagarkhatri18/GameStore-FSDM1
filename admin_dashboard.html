<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <link href="assets/css/admin.css" rel="stylesheet" />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />

    <!-- jQuery toast plugin -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css"
    />

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>

    <script>
      var checkLoggedIn = localStorage.getItem("adminLoggedIn");
      if (checkLoggedIn == null || checkLoggedIn === "false") {
        window.location.href = "/admin_login.html";
      }
    </script>
  </head>

  <body>
    <div class="wrapper">
      <header>
        <span>GameStore Admin Panel</span>
        <span class="header-right-content"
          ><a href="/index.html">Home Page</a></span
        >
        <span class="header-right-content" id="logout"
          ><a href="javascript:void(0)">Logout</a></span
        >
      </header>
      <div class="container">
        <div class="main">
          <div class="row">
            <div class="col-6">
              <h4>Categories Lists</h4>
            </div>

            <div class="col-6 text-end">
              <button
                type="button"
                id="add_new_category"
                class="btn btn-sm btn-success"
              >
                Add New
              </button>
            </div>
          </div>

          <table class="categories-lists-table table">
            <thead>
              <tr>
                <th scope="col">S.N</th>
                <th scope="col">ID</th>
                <th scope="col">Name</th>
                <th scope="col">Alt Text</th>
                <th scope="col">Image</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody id="categories-lisis"></tbody>
          </table>
        </div>
      </div>
      <div class="container">
        <h4>Products Lists</h4>
        <button id="add-product">Add Product</button>
        <table class="products-lists-table table">
          <thead>
            <tr>
              <th scope="col">S.N</th>
              <th scope="col">ID</th>
              <th scope="col">Category Name</th>
              <th scope="col">Name</th>
              <th scope="col">Brand</th>
              <th scope="col">Price</th>
              <th scope="col">Image</th>
            </tr>
          </thead>
          <tbody id="products-lists"></tbody>
        </table>
      </div>
      <footer>
        <p>&copy; GameStore | All Right Reserved 2023</p>
      </footer>
    </div>

    <!-- Add New Category Modal -->
    <div
      class="modal fade"
      id="addCategoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="addCategoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <form id="add_category_form" method="post">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addCategoryModalLabel">
                Add New Category
              </h5>
              <button
                type="button"
                class="mt-0 modal-close-button btn btn-primary"
                data-bs-dismiss="modal"
              >
                &times;
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="name"
                  >Category Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  required
                  name="name"
                  placeholder="Enter category name"
                />
                <span class="text-danger"></span>
              </div>
              <input
                type="hidden"
                class="form-control"
                id="category_id"
                name="category_id"
                value=""
              />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button
                type="button"
                id="add_category_submit"
                class="btn btn-primary"
              >
                Submit
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // api call to load categories data
        $.ajax({
          url: "/api/admin/categories",
          method: "GET",
          success: function (data) {
            displayCategoryData(data.data);
          },
          error: function (err) {
            console.log(err);
          },
        });

        // api call to load products data
        $.ajax({
          url: "/api/admin/products",
          method: "GET",
          success: function (data) {
            displayProductData(data.data);
          },
          error: function (err) {
            console.log(err);
          },
        });

        $(`#logout`).on("click", function (e) {
          localStorage.setItem("adminLoggedIn", false);
          window.location.reload();
        });

        $(`#add_new_category`).on("click", function (e) {
          e.preventDefault();
          $(`#name`).val("");
          $(`#category_id`).val("");
          $(`#addCategoryModal`).modal("show");
        });

        $(`#add_category_submit`).on("click", (e) => {
          e.preventDefault();
          if ($(`#name`).val().trim() == "") {
            $.toast({
              heading: "Failed",
              text: "Category name is required",
              showHideTransition: "slide",
              icon: "error",
              position: "top-right",
              allowToastClose: true,
            });
            return false;
          }

          let formData = $(`#add_category_form`).serializeArray();
          addUpdateCategory(formData);
        });

        $(`#add-product`).on("click", function (e) {
          e.preventDefault();
          // TODO:  this item will be made from form data
          let item = {
            category_id: "2",
            name: "GTA 5 - PC",
            brand: "Rockstar",
            new: true,
            price: {
              original: 34.54,
              sale: 33.23,
            },
            description: "GTA for pc",
            specification: {
              product_code: "769864 Playd",
              ideal_for: "PC, PS4, PS5",
              Genre: "Racing",
              release_date: "2022-04-11",
            },
          };
          let jsonString = JSON.stringify(item);
          addProduct(jsonString);
        });
      });

      function addProduct(formData) {
        $.ajax({
          url: "/api/admin/add-product",
          data: formData,
          method: "POST",
          success: function (data) {
            console.log(data, " x res");
            // window.location.reload();
          },
          error: function (err) {
            console.log(err.responseJSON.data);
            $.toast({
              heading: "Failed",
              text: err.responseJSON.message,
              showHideTransition: "slide",
              icon: "error",
              position: "top-right",
              allowToastClose: true,
            });
          },
        });
      }

      // handle the insert or udpate of the category
      function addUpdateCategory(formData) {
        $.ajax({
          url: "/api/admin/add-category",
          data: formData,
          method: "POST",
          success: function (data) {
            window.location.reload();
          },
          error: function (err) {
            $.toast({
              heading: "Failed",
              text: err.responseJSON.message,
              showHideTransition: "slide",
              icon: "error",
              position: "top-right",
              allowToastClose: true,
            });
          },
        });
      }

      function displayCategoryData(data) {
        var appendData = "";
        data.forEach((item, index) => {
          appendData += `
              <tr>
                  <th scope="row">${index + 1}</th>
                  <td>${item.id}</td>
                  <td>${item.name}</td>
                  <td>${item.alt}</td>
                  <td>
                      <img src="${item.src}" alt=${item.alt}/>
                  </td>
                  <td>
                      <a href="javascript:void(0)" onClick="deleteCategory('${
                        item.id
                      }')">[Delete]</a>&nbsp; | &nbsp;
                      <a href="javascript:void(0)" onClick="updateCategory('${
                        item.id
                      }', '${item.name}')">[Edit]</a>
                  </td>
              </tr>
              `;
        });
        $(`#categories-lisis`).html(appendData);
      }

      function displayProductData(data) {
        appendData = "";
        data.forEach((item, index) => {
          appendData += `
              <tr>
                  <th scope="row">${index + 1}</th>
                  <td>${item.id}</td>
                  <td>${item.category_name}</td>
                  <td>${item.name}</td>
                  <td>${item.brand}</td>
                  <td>${item.price.sale}</td>
                  <td>
                      <img src="${item.img.src}" alt=${item.img.alt}/>
                  </td>
              </tr>
              `;
        });
        $(`#products-lists`).html(appendData);
      }

      // delete the selected category
      function deleteCategory(category_id) {
        $.ajax({
          url: `/api/admin//category/${category_id}`,
          method: "DELETE",
          success: function (data) {
            window.location.reload();
          },
          error: function (err) {
            $.toast({
              heading: "Failed",
              text: err.responseJSON.message,
              showHideTransition: "slide",
              icon: "error",
              position: "top-right",
              allowToastClose: true,
            });
          },
        });
      }

      // update the selected category
      function updateCategory(category_id, name) {
        $(`#name`).val(name);
        $(`#category_id`).val(category_id);
        $(`#addCategoryModal`).modal("show");
      }
    </script>
  </body>
</html>
